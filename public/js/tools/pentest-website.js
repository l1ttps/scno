$(document).ready(function() {
    // window.onbeforeunload = function() {
    //     return "Are you sure?";
    // }

    // $(function() {
    //     $('input[type="checkbox"]').click(function() {
    //         window.onbeforeunload = function() {};
    //     });
    // });
    $.get("http://localhost:8090/JSON/ascan/action/removeAllScans/");
    $.get("/api/pentest-website/status", function(data) {
        var status_services = data.message;
        if (status_services == "Not Running") {
            $.confirm({
                title: 'An error occurred',
                content: 'Our service is experiencing some problems',
                type: 'red',
                typeAnimated: true,
                buttons: {
                    tryAgain: {
                        text: 'Try again',
                        btnClass: 'btn-red',
                        action: function() {
                            location.reload();
                        }
                    },
                    close: function() {
                        window.location.href = "/";
                    }
                }
            });
        }
    })
    var api_key = $.cookie('api_key');
    var id_scan;
    $("#btn_scan").click(function() {
        var target = $("#url").val();
        $(".show_progress").show(100);
        $(".progress_spider").html("<div class='progress'><div class='progress-bar progress-bar-striped progress-bar-animated' role='progressbar' style='width: 3%;' aria-valuemin='0' aria-valuemax='100'>1%</div></div>");
        $.ajax({
            url: ' api/pentest-website/spider/',
            type: 'post',
            data: { url: target, api_key: api_key },
            dataType: 'json',
            success: function(response) {
                id_scan = response.id;
                status_spider(id_scan, api_key);
            }
        });
    });

    function show_resuilt() {
        $(".tool-name").hide(500);
        $(".hero-banner").css("padding-top", "0px");
        $(".resuilt").show();
        $(".checkbox").hide();
    }

    function status_spider(id, api_key) {
        var status = 0;
        var on_time = setInterval(function() {
            var request_get_status_spider = $.ajax({
                url: 'api/pentest-website/spider/status',
                type: 'get',
                data: { scanId: id, api_key: api_key },
                dataType: 'json'
            });
            request_get_status_spider.then(function(data) {
                status = data.status;
                $(".progress_spider").html("<div class='progress'><div class='progress-bar progress-bar-striped progress-bar-animated' role='progressbar' style='width: " + status + "%;' aria-valuemin='0' aria-valuemax='100'>" + status + "%</div></div>");
                if (status == 100) {
                    var id = data.active_scan;
                    clearInterval(on_time);
                    $(".progress_spider").html("<div class='progress'><div class='progress-bar bg-success' role='progressbar' style='width: 100%' aria-valuenow='100' aria-valuemin='0' aria-valuemax='100'>Success</div></div>");
                    var time_get_status_ascan = setInterval(function() {
                        var request_get_status_ascan = $.ajax({
                            url: 'api/pentest-website/active-scan/status',
                            type: 'post',
                            data: { id: id, api_key: api_key },
                            dataType: 'json'
                        });
                        request_get_status_ascan.then(function(data) {
                            status_ascan = data.status;
                            var int_status_ascan = parseInt(status_ascan);
                            if (int_status_ascan > 4) {
                                show_resuilt();
                            }
                            if (status) {
                                $(".progress_scan").html("<div class='progress'><div class='progress-bar progress-bar-striped progress-bar-animated' role='progressbar' style='width: " + status_ascan + "%;' aria-valuemin='0' aria-valuemax='100'>" + status_ascan + "%</div></div>");
                            }
                        });
                    }, 1500);
                }
            });
        }, 1500);
    }
});